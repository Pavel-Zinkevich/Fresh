# -*- coding: utf-8 -*-
"""Untitled20.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1fiK1mrdqH_z8VKc8-yFxpGEKl_f7XlZR
"""

import streamlit as st
from PIL import Image
import numpy as np
import tensorflow as tf

# -----------------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# -----------------------------
IMG_WIDTH, IMG_HEIGHT = 256, 256

# –ü—É—Ç–∏ –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –º–æ–¥–µ–ª—è–º
FRESHNESS_MODEL_PATH = "freshness_model.keras"
FRUIT_MODEL_PATH = "fruit_model.keras"

# –ö–ª–∞—Å—Å—ã –º–æ–¥–µ–ª–µ–π
freshness_classes = ["fresh", "rotten"]
fruit_classes = ["apple", "banana", "strawberry"]

# -----------------------------
# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª–∏
# -----------------------------
@st.cache_resource
def load_model(path):
    return tf.keras.models.load_model(path)

freshness_model = load_model(FRESHNESS_MODEL_PATH)
fruit_model = load_model(FRUIT_MODEL_PATH)

# -----------------------------
# –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å
# -----------------------------
st.title("Fruit Freshness & Type Classifier üçéüçåüçì")
st.write("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ—Ä—É–∫—Ç–∞, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –µ–≥–æ —Ç–∏–ø –∏ —Å–≤–µ–∂–µ—Å—Ç—å.")

uploaded_file = st.file_uploader("–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", type=["jpg", "jpeg", "png"])

if uploaded_file is not None:
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    image = Image.open(uploaded_file).convert("RGB")
    st.image(image, caption="Uploaded Image", use_column_width=True)

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –º–æ–¥–µ–ª–∏
    resized_img = image.resize((IMG_WIDTH, IMG_HEIGHT))
    input_array = np.expand_dims(np.array(resized_img)/255.0, axis=0)  # (1, 256, 256, 3)

    # -----------------------------
    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Å–≤–µ–∂–µ—Å—Ç–∏
    # -----------------------------
    freshness_pred = freshness_model.predict(input_array)
    freshness_idx = np.argmax(freshness_pred, axis=1)[0]
    freshness_result = freshness_classes[freshness_idx]
    freshness_conf = freshness_pred[0][freshness_idx]

    # -----------------------------
    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ç–∏–ø–∞ —Ñ—Ä—É–∫—Ç–∞
    # -----------------------------
    fruit_pred = fruit_model.predict(input_array)
    fruit_idx = np.argmax(fruit_pred, axis=1)[0]
    fruit_result = fruit_classes[fruit_idx]
    fruit_conf = fruit_pred[0][fruit_idx]

    # -----------------------------
    # –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    # -----------------------------
    st.success(f"Prediction: {fruit_result} ({freshness_result})")
    st.write(f"Fruit confidence: {fruit_conf:.2%}")
    st.write(f"Freshness confidence: {freshness_conf:.2%}")